<?php
  /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +                        CSS стили                               +
  + --------------------------------------------------------------*/
  
include("engine/search/css/style.php");
  
  /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +                      JS document.ready                         +
  + --------------------------------------------------------------*/

include("engine/search/js/js_up.php");

	/* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
	+              Название: | MINISTRYBOOKS.RU Search               +
	+ -------------------------------------------------------------- +
	+                Версия: | 1.0                                   +
	+             Тип:       | скрипт поиска по сайту                +
	+            Требования: | PHP5                                  +
	+             Платформа: | любая                                 +
	+                  Язык: | русский                               +
	+                 Автор: | Korolev Evgeniy (http://www.kbk.ru)   +
	+   Copyright 2016-2017: | © KBK.RU - All Rights Reserved.        +
	+ -------------------------------------------------------------- +
	+              Обновлен: | 16 ноября 2016                        +
	+ + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + */

############################################################################

include 'safemysql.class.php';

// ставим скрипт "на счетчик" (чтобы знать, как долго он выполнялся)
$ttt=microtime();
$ttt=((double)strstr($ttt, ' ')+(double)substr($ttt,0,strpos($ttt,' ')));

// хлебные крошки (навигация)
print '<ul class="breadcrumbs">
      <li><a href="index.cfm">Главная</a></li>
      <li class="current"><a href="/?mod=search_on_site">Поиск по книгам</a></li>
    </ul>';
print "<h2>Поиск по книгам</h2>";

	/* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
	+                     Инициализация переменных                   +
	+ --------------------------------------------------------------*/

$srcStr = $_GET['srcStr'];   //  Инициализация переменной для GET для нового поиска

	/* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
	+                   Открываем сессию                             +
	+ --------------------------------------------------------------*/

  session_start();

	/* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
	+                удаление сессии по GET запросу                  +
	+ --------------------------------------------------------------*/

if (strlen($_GET['srcStr'])>0 || isset($srcStr) || !empty($srcStr)) {
    unset($_SESSION['template']);
    unset($_SESSION['temp']);
    unset($_SESSION['search_by_author']);
    unset($_SESSION['search_by_logic']);
    unset($_SESSION['search_by_stype']);
    session_destroy();
    echo "<HTML><HEAD><META HTTP-EQUIV='Refresh' CONTENT='0; URL=?mod=search_on_site'></HEAD></HTML>";
    return;
}

	/* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +                        Выпадющие списки                        +
  + --------------------------------------------------------------*/
  
include("engine/search/html/options_html.php");
  
  /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +                        шумовые слова                           +
  + --------------------------------------------------------------*/

include("engine/search/data/noise_words.php");

// На случай пустого запроса и шумовых слов
if (!empty($_POST['search']) AND isset($_POST["template"]) AND !empty($_POST["template"]) AND !in_array(mb_strtolower($_POST["template"], 'utf-8'), $noise_words)) {
  echo '<div id="preloader"></div>';
}

  /*  + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +                     Форма поиска по книгам                      +
  +----------------------------------------------------------------*/

include("engine/search/html/form.php");

//==================================================================

  /*  + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +          Подключает класс извлечения корня слова                +
  +----------------------------------------------------------------*/
$vendorDir = __DIR__ . '';
if (file_exists($file = $vendorDir . '/FIL/1.inc')) {
   require_once $file;
}

  /*  + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +                                                                 +
  +          ОТПРАВКА ДАННЫХ В ФОРМУ ПОИСКА, POST                   +
  +                                                                 +
  +----------------------------------------------------------------*/

if (!empty($_POST['search']) || isset($_GET['part'])) {
  //   if (count($out) < 1 || !is_array($out))

    /*  + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
    +          Подключает класс извлечения корня слова                +
    +----------------------------------------------------------------*/

  $vendorDir = __DIR__ . '';
  if (file_exists($file = $vendorDir . '/NXP/Stemmer.php')) {
     require_once $file;
   }

    /*  + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
    +     Инициализируем Переменные выбора критерия поиска            +
    +----------------------------------------------------------------*/    

  $logic = $_POST['logic'];
  if($logic != 'OR') $logic = 'AND';  // Выбор Логики поиска: И, ИЛИ

  $search_by = $_POST['search_by'];   // Выбор критерия поиска по категории

  $stype = $_POST['stype'];
  if($stype != 'F') $stype = 'S';      // Выбор критерия поиска по автору

	  /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
	  +                   Помещаем переменные в сессию                 +
	  + --------------------------------------------------------------*/

  if (isset($_POST["template"])) {
      $template = strip_tags($_POST['template']);
      $_SESSION['template']=$_POST['template'];
      $_SESSION['temp']=$_POST['template'];
      $_SESSION['search_by_author']=$_POST['search_by'];
      $_SESSION['search_by_logic']=$_POST['logic'];
      $_SESSION['search_by_stype']=$_POST['stype'];
  }

  $template = strip_tags($_SESSION['template']);
  $templateid = strip_tags($_SESSION['temp']);
  $search_books_by_author = strip_tags($_SESSION['search_by_author']);
  $search_books_by_logic = strip_tags($_SESSION['search_by_logic']);
  $search_books_by_stype = strip_tags($_SESSION['search_by_stype']);

    /*  + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
    +                          Точное совпадение                      +
    +----------------------------------------------------------------*/

  if($search_books_by_stype == 'S') {
      // точное соответствие
      include("engine/search/controller/exact_match.php");
      $wrd_cnt = count($stemmed);
  } else {

    /*  + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
    +                          Включая все словоформы                 +
    +----------------------------------------------------------------*/

      include("engine/search/controller/word_forms.php");
      $wrd_cnt = count($stemmed);
  }

    /*++++++++++++++++++++++++++++++++++
    + работаем с полученным массивом   +
    +-----------------------------------*/

  $result = implode(', ', $stemmed);
  $_SESSION['words_sessia'] = serialize($stemmed);    //  !не удалять сессию
  $_SESSION['words_stemmed'] = $result;               //  !не удалять сессию
    
    /*+++++++++++++++++++++++++++++++++++
    +     Сообщения об ошибках html   +
    +-----------------------------------*/     

  include("engine/search/html/error_msgs.php");

//==================================================================

    /*+++++++++++++++++++++++++++++++++++
    +         ЗАПРОСЫ MySQL             +
    +-----------------------------------*/

    /*+++++++++++++++++++++++++++++++++++++++++++++++++++++
    +          Готовим условие все или по автору          +
    +-----------------------------------------------------*/

  include("engine/search/core/cndt_by_author.php");

  $_SESSION['books_by_author'] = $books_by_author;

    /*+++++++++++++++++++++++++++++++++++++
    +      Готовим и исполняем запрос     +
    +-------------------------------------*/

  // поиск по книгам
  include("engine/search/core/core_search.php");   

//==================================================================

   /*++++++++++++++++++++++++++++++++++++++
    +   Обрабатываем результат запроса    +
    +-------------------------------------*/

  // поиск в массиве
  include("engine/search/controller/search_controller.php");

//==================================================================

   /*++++++++++++++++++++++++++++++++++++++
    +        Оформляем результаты         +
    +-------------------------------------*/

  // считаем кол-во совпадений
  foreach ($arr as $elements => $element) {
    $vcount = count($element) + $vcount;
  }

  if($vcount > 0) {

    // оформляем и записываем в сессии
    include("engine/search/controller/prepare_result.php");

    // Переходим к результатам поиска на другую страницу
    echo "<HTML><HEAD><META HTTP-EQUIV='Refresh' CONTENT='0; URL=?mod=search_tips'></HEAD></HTML>";

    //==================================================================

	   /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
	   +                          КОНЕЦ                                 +
	   + --------------------------------------------------------------*/
  } else  {
	   /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
	   +	                                                         +
	   +      Сообщение, если ничего не найдено по запросу              +
	   +	                                                         +
	   + --------------------------------------------------------------*/
  
    include("engine/search/js/js_bottom.php");

	   /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
	   +                          ОЧИЩАЕМ СЕССИЮ                        +
	   + --------------------------------------------------------------*/

    unset($_SESSION['template']);
    unset($_SESSION['temp']);
    unset($_SESSION['search_by_author']);
    unset($_SESSION['search_by_logic']);
    unset($_SESSION['search_by_stype']);
    session_destroy();
    return;

    //==================================================================

 } 

  /*  + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +                                                                 +
  +                 КОНЕЦ | ОТПРАВКА ДАННЫХ В ФОРМУ                 +
  +                                                                 +
  +----------------------------------------------------------------*/

  //==================================================================

}

//==================================================================

  /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +                          Счётчик                               +
  + --------------------------------------------------------------*/

include("engine/search/extra/counter.php");

//==================================================================

  /* + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + +
  +          Закоментированное описание поиска (html)              +
  + --------------------------------------------------------------*/

include("engine/search/html/html_bottom.php");